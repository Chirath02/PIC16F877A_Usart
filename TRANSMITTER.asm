TITLE "SCANNING THE KEYPAD"
list p = 16f877
include <p16f877.inc>

ORG 0X00
GOTO START

ORG 0X04
GOTO INTERRUPT

BANK0 macro
bcf STATUS,RP0
bcf STATUS,RP1
endm

BANK1 macro
bsf STATUS,RP0
bcf STATUS,RP1
endm

BANK2 macro
bcf STATUS,RP0
bsf STATUS,RP1
endm

BANK3 macro
bsf STATUS,RP0
bsf STATUS,RP1
endm



DELAY_TIME EQU 0x20
KEYDATA EQU PORTB










ORG 0X40

START:
;****



NOP 

BANK0
MOVLW 0XC0
MOVWF INTCON
MOVLW 0X00
MOVWF 0X20
MOVLW 0X0A
MOVWF 0X21

BANK1
BSF PIE1,TXIE
CLRF TRISB
MOVLW 0XFF
MOVWF TRISD
MOVLW 0X80
MOVWF TRISC
CLRF TXSTA
BSF TXSTA,BRGH
MOVLW D'25'
MOVWF SPBRG

BANK0
CLRF RCSTA
BSF RCSTA,SPEN

BANK1
BSF TXSTA,TXEN

BANK0

LOOP1:
BANK0
BSF PIR1,TXIF
GOTO LOOP1





























INTERRUPT:
BANK0
BTFSS PIR1,TXIF
GOTO LOOP1
ISR:
BANK0
BCF INTCON,GIE
BCF INTCON,PEIE
BCF PIR1,TXIF
BANK1
BCF PIE1,TXIE
BTFSS TXSTA, TRMT
GOTO LOOP1
GOTO TRANSMITT

TER1:
BANK0
BSF INTCON,PEIE
BSF INTCON,GIE
BCF PIR1,TXIF
BANK1
BSF PIE1,TXIE
RETFIE
;TER2:
;BANK0
;BSF INTCON,PEIE
;BSF INTCON,GIE
;BANK1
;BSF PIE1,TXIE
;GOTO START

TRANSMITT:
BANK0
MOVF PORTB,0
MOVWF TXREG
CALL DELAY1
CALL KEYPAD
INCF 0X20,1
MOVF 0X20,0
DECFSZ 0X21,1
GOTO TER1
;BANK0
;CLRF INTCON
;BANK1
;CLRF PIE1
GOTO START

DELAY1:
MOVLW 0X05
MOVWF 0X30
L1:
MOVLW 0XFF
MOVWF 0X31
L2:
MOVLW 0XFF
MOVWF 0X32
L3:
DECFSZ 0X32,1
GOTO L3
DECFSZ 0X31,1
GOTO L2
DECFSZ 0X30,1
GOTO L1
RETURN


























KEYPAD:
CALL INIT_PORTS 


SCAN 

;--------------Column 1-----------------
MOVLW 1 ;SET  ROW1  HIGH
MOVWF PORTD 


BTFSS PORTD,7 ;TEST column1   
GOTO SIX ;IF NOT fig-1, TRY 6
MOVLW 0xFF
MOVWF KEYDATA 
GOTO LAST 

SIX BTFSS PORTD,6 ;TEST COLUMN 1 No €
GOTO NINE ;IF NOT 6, TRY 9
MOVLW 0x09 ;ELSE STORE 9
MOVWF KEYDATA ;IN KEyDATA
GOTO LAST ;AND FINISH

NINE BTFSS PORTD,5 ;TEST COLUMN 2 No 5
GOTO NUM ;IF NOT 5, TRY NUM *
MOVLW 6 ;ELSE STORE 6
MOVWF KEYDATA ;IN KEyDATA
GOTO LAST ;AND FINISH

NUM BTFSS PORTD,4 ;TEST cOLUMN 3 NUM *
GOTO COL2 ;IF NOT NUM, TRY COL 2
MOVLW 0x03 ;ELSE SToRE FFH
MOVWF KEYDATA ;IN KEyDATA
GOTO LAST ;AND FINISH


COL2 MOVLW 2 ;SET ROW 2 HIGH
MOVWF PORTD ;AND OUTPUT
BTFSS PORTD,7 ;TEST COLUMN 2 No 2
GOTO FIVE ;IF NOT 2, TRY 5
MOVLW 0x00 ;ELSE STORE 2
MOVWF KEYDATA ;IN KEyDATA
GOTO LAST ;AND FINISH

FIVE BTFSS PORTD,6 ;TEST COLUMN 2 No 5
GOTO EIGHT ;IF NOT 5, TRY
MOVLW 0x08 ;ELSE SToRE 5
MOVWF KEYDATA ;IN KEYDATA
GOTO LAST ;AND FINISH

EIGHT BTFSS PORTD,5 ;TEST COLJMN 2 No 8
GOTO NONE ;IF NOT 8, TRY 0
MOVLW 0x05 ;EISE STORE 8
MOVWF KEYDATA ;IN KEYDATA
GOTO LAST ;AND FINISH

NONE BTFSS PORTD,4 ;TEST COIIJMN 2 No 0
GOTO COL3 ;IF NoT ZERo, TRy CoL 3
MOVLW 0x02 ;ELSE SToRE 0
MOVWF KEYDATA ;IN KEYDATA
GOTO LAST ;AND FINISH

COL3 MOVLW 4 ;SET RoW 3 HIGH
MOVWF PORTD ;AND OUTPUT
BTFSS PORTD,7 ;TEST cOLJw’iN 3 No 1
GOTO FOUR ;IF NoT 1, TRy 4
MOVLW 0XFF ;ELSE SToRE 1
MOVWF KEYDATA 
GOTO LAST 

FOUR BTFSS PORTD,6
GOTO SEVEN
MOVLW 0x07
MOVWF KEYDATA
GOTO LAST

SEVEN BTFSS PORTD,5 ;TEST COLJ 3 No 7
GOTO STAR ;IF NOT 7, TRY
MOVLW 0x04
MOVWF KEYDATA 
GOTO LAST 

STAR BTFSS PORTD,4 ;TEST COLJMN 3 ‘
GOTO LOOP ;IF NOT a, TRY REPEAT
MOVLW 0x01 
MOVWF KEYDATA 
GOTO LAST 

LAST CALL DELAY ;DEBoUNDz KEYPAD
LOOP
;LOOP MOVF PORTD,W ;READ PORT
;ANDLW 0xF0 ;MASK OL5
;BTFSS STATUS,Z ;AND WAIT TILL No PRESSED
;GOTO LOOP
RETURN 

; PORT INTIAlISATION


INIT_PORTS 
BANK1 
MOVLW 0xF0 
MOVWF TRISD
CLRF TRISB
BANK0 
RETURN


DELAY MOVWF 0X30
      MOVLW 0xFF
      MOVWF DELAY_TIME
      
WAIT INCFSZ DELAY_TIME
     GOTO WAIT
     MOVF 0X30,W
     RETURN 

END 